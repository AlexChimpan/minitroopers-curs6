openapi: 3.0.3
info:
  title: Maintenance Task API
  description: API for managing vehicle maintenance tasks
  version: 1.0.0
  contact:
    name: BMW Maintenance Team

servers:
  - url: http://localhost:8080/maintenance-service
    description: Local development server

tags:
  - name: Maintenance Tasks
    description: Operations for managing maintenance tasks

paths:
  /maintenance-tasks:
    get:
      summary: List all maintenance tasks
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MaintenanceTask"
    post:
      summary: Create a new maintenance task
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MaintenanceTaskCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceTask"

  /maintenance-tasks/{taskId}:
    get:
      summary: Get a maintenance task by id
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceTask"
        "404":
          description: Not Found
    patch:
      summary: Update a maintenance task (status/notes)
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MaintenanceTaskUpdateRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceTask"
        "404":
          description: Not Found

  /maintenance-tasks/by-vin/{vin}:
    get:
      summary: List maintenance tasks by VIN
      parameters:
        - name: vin
          in: path
          required: true
          schema:
            type: string
            minLength: 1
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MaintenanceTask"

components:
  schemas:
    TaskType:
      type: string
      description: Type of maintenance task
      enum:
        - OIL_CHANGE
        - BRAKE_INSPECTION
        - TIRE_SERVICE
        - DIAGNOSTIC_SCAN

    TaskStatus:
      type: string
      description: Status of a maintenance task
      enum:
        - IN_PROGRESS
        - DONE
        - CANCELED

    TirePosition:
      type: string
      description: Position(s) involved in a tire service task
      enum:
        - FRONT_LEFT
        - FRONT_RIGHT
        - REAR_LEFT
        - REAR_RIGHT
        - ALL

    ScannerType:
      type: string
      description: Diagnostic scanner type used for a diagnostic scan
      enum:
        - BASIC
        - ADVANCED

    MaintenanceTask:
      type: object
      properties:
        taskId:
          type: integer
          format: int64
        vin:
          type: string
        type:
          $ref: "#/components/schemas/TaskType"
        status:
          $ref: "#/components/schemas/TaskStatus"
        notes:
          type: string
        tirePosition:
          $ref: "#/components/schemas/TirePosition"
        scannerType:
          $ref: "#/components/schemas/ScannerType"
        errorCodes:
          type: array
          items:
            type: string
      required:
        - taskId
        - vin
        - type
        - status
      description: >
        Maintenance task. Some fields are conditionally required depending on type.

    MaintenanceTaskCreateRequest:
      oneOf:
        - $ref: "#/components/schemas/MaintenanceTaskCreateBase"
        - $ref: "#/components/schemas/MaintenanceTaskCreateTireService"
        - $ref: "#/components/schemas/MaintenanceTaskCreateDiagnosticScan"
      discriminator:
        propertyName: type
        mapping:
          OIL_CHANGE: "#/components/schemas/MaintenanceTaskCreateBase"
          BRAKE_INSPECTION: "#/components/schemas/MaintenanceTaskCreateBase"
          TIRE_SERVICE: "#/components/schemas/MaintenanceTaskCreateTireService"
          DIAGNOSTIC_SCAN: "#/components/schemas/MaintenanceTaskCreateDiagnosticScan"

    MaintenanceTaskCreateBase:
      type: object
      properties:
        vin:
          type: string
        type:
          $ref: "#/components/schemas/TaskType"
        notes:
          type: string
      required:
        - vin
        - type
      description: >
        Create request for generic task types (OIL_CHANGE, BRAKE_INSPECTION).
      allOf:
        - $ref: "#/components/schemas/MaintenanceTaskCreateConstraintsBase"

    MaintenanceTaskCreateConstraintsBase:
      type: object
      properties:
        type:
          type: string
      description: Used to constrain type values in oneOf branches.

    MaintenanceTaskCreateTireService:
      type: object
      properties:
        vin:
          type: string
        type:
          type: string
          enum: [TIRE_SERVICE]
        notes:
          type: string
        tirePosition:
          $ref: "#/components/schemas/TirePosition"
      required:
        - vin
        - type
        - tirePosition
      description: Create request for TIRE_SERVICE tasks.

    MaintenanceTaskCreateDiagnosticScan:
      type: object
      properties:
        vin:
          type: string
        type:
          type: string
          enum: [DIAGNOSTIC_SCAN]
        notes:
          type: string
        scannerType:
          $ref: "#/components/schemas/ScannerType"
        errorCodes:
          type: array
          items:
            type: string
      required:
        - vin
        - type
        - scannerType
        - errorCodes
      description: Create request for DIAGNOSTIC_SCAN tasks.

    MaintenanceTaskUpdateRequest:
      oneOf:
        - $ref: "#/components/schemas/MaintenanceTaskUpdateStatus"
        - $ref: "#/components/schemas/MaintenanceTaskUpdateNotes"
      description: >
        Update request. Existing endpoints remain unchanged; payload can update status or notes.

    MaintenanceTaskUpdateStatus:
      type: object
      properties:
        status:
          $ref: "#/components/schemas/TaskStatus"
      required:
        - status

    MaintenanceTaskUpdateNotes:
      type: object
      properties:
        notes:
          type: string
      required:
        - notes